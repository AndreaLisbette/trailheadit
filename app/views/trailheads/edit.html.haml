.container
  .row
    .col-md-8.col-md-offset-2
      %h2 Edit Trailhead 
      - if @trailhead.user
        %h4 from #{@trailhead.user.try :email}
      %hr
      - trailhead = @trailhead
      - content_for :title do
        = ['Trail Editor : Trailhead',trailhead.name,trailhead.address].compact().join(" : ")

      .row
        .col-md-8.col-md-offset-2    
          .trailhead-box 
            .row
              .col-sm-10.col-xs-12
                %h2= trailhead.display_name      
                - if trailhead.user
                  %h4
                    = link_to trailheads_path(user_id:trailhead.user.id) do
                      #{trailhead.user}                

              .col-sm-2.col-xs-12.text-center
                :erb
                  <a href="https://twitter.com/share" class="twitter-share-button" data-text="Check out this trailhead!" data-size="large" data-count="none" data-hashtags="traileditor">Tweet</a>
                  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
            
            %hr
            -# %hr
            .photo-box
              = link_to trailhead.photo.url(:oriented) do
                = image_tag (trailhead.photo.url(:large) || "trailheadit_hq.jpg"), class: "img-responsive"
            .share.text-center
            .trailhead-map(id="trailhead-map-#{trailhead.id}")
            %pre#coordinates.ui-coordinates
            %a#geolocate.ui-button{href: "#"} Relocate to my Current Location
            .row
              .col-sm-9.col.xs-12
                = trailhead.address
                %br
                
              .col-xs-12.col-sm-3.text-center
                .btn-group
                  %button.btn.btn-primary.dropdown-toggle{"data-toggle" => "dropdown", type: "button"}
                    Open in
                    %span.caret
                  %ul.dropdown-menu.pull-right{role: "menu"}
                    %li
                      = link_to "OpenStreetMap", "http://www.openstreetmap.org/?mlat=#{trailhead.latitude}&mlon=#{trailhead.longitude}#map=15/#{trailhead.latitude}/#{trailhead.longitude}", target: :blank, class: "btn btn-block"
                    %li.divider
                    %li
                      = link_to "Google Maps", "http://maps.google.com?q=#{trailhead.latlng}", target: :blank, class: "btn btn-block"

      = render 'form'
:javascript
  var myMap = L.mapbox.map('trailhead-map-#{trailhead.id}', 'jerememonteau.holfp9ah')
  myMap.setView([#{trailhead.latitude}, #{trailhead.longitude}], 15);
  var marker = L.marker(
    new L.LatLng(#{trailhead.latitude}, #{trailhead.longitude}), {
      icon: L.mapbox.marker.icon({'marker-color': 'ff8888'}),
      draggable: true
      });
  marker.addTo(myMap);
  var myLayer = L.mapbox.featureLayer().addTo(myMap);
  var geolocate = document.getElementById('geolocate');
  marker.on('drag', ondrag);
  marker.on('dragend', set_gps_form);
  ondrag();
  function ondrag() {
    var m = marker.getLatLng();
    coordinates.innerHTML = 'Latitude: ' + m.lat + '<br/>Longitude: ' + m.lng;
  };
  function set_gps_form() {
    var m = marker.getLatLng();
    $("#trailhead_latitude").val(m.lat);
    $("#trailhead_longitude").val(m.lng);
  };
  geolocate.onclick = function(e) {
    e.preventDefault();
    e.stopPropagation();
    myMap.locate();
  };
  myMap.on('locationfound', function(e) {
    myMap.fitBounds(e.bounds);
    marker.setLatLng([e.latlng.lat, e.latlng.lng]);
    ondrag();
    set_gps_form();
  });

  myMap.on('locationerror', function() {
    geolocate.innerHTML = 'Position could not be found';
  });